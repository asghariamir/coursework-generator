<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Coursework LaTeX Generator ‚Äî NM & DS (Corrected)</title>
<style>
:root{--ink:#111827;--muted:#6b7280;--primary:#2563eb;--bg:#f9fafb;--card:#fff;--border:#e5e7eb}
*{box-sizing:border-box}
html,body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
.container{max-width:1200px;margin:0 auto;padding:20px}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:40px 20px;text-align:center;border-radius:12px;margin-bottom:30px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
.header h1{margin:0 0 10px;font-size:36px;font-weight:700}
.header p{margin:0;opacity:0.95;font-size:18px}
.card{background:var(--card);border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 4px 6px rgba(0,0,0,0.07)}
.card h2{color:var(--primary);margin:0 0 20px;font-size:24px;display:flex;align-items:center;gap:10px}
.btn-group{display:flex;gap:12px;flex-wrap:wrap;margin:20px 0}
button{padding:12px 24px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s}
.btn-primary{background:var(--primary);color:white}
.btn-primary:hover{background:#1d4ed8;transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,0.2)}
.btn-danger{background:#dc2626;color:white}
.btn-danger:hover{background:#b91c1c}
.btn-success{background:#10b981;color:white}
.btn-success:hover{background:#059669}
.btn-secondary{background:#6b7280;color:white}
.btn-secondary:hover{background:#4b5563}
.course-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:20px 0}
.course-btn{padding:16px;border:2px solid var(--border);border-radius:8px;background:white;cursor:pointer;transition:all 0.2s;text-align:left}
.course-btn:hover{border-color:var(--primary);background:#f0f4ff}
.course-btn.active{border-color:var(--primary);background:linear-gradient(to right,#f0f4ff,#e6efff);box-shadow:0 2px 8px rgba(37,99,235,0.1)}
.course-btn h3{margin:0 0 4px;color:var(--primary);font-size:16px}
.course-btn p{margin:0;font-size:13px;color:var(--muted)}
.preview-box{background:#1e1e1e;color:#d4d4d4;border-radius:8px;padding:20px;min-height:300px;max-height:500px;overflow-y:auto;font-family:'Courier New',monospace;font-size:12px;line-height:1.5;white-space:pre-wrap;width:100%}
.student-list{background:#f3f4f6;padding:15px;border-radius:8px;max-height:400px;overflow-y:auto}
.student-item{display:flex;justify-content:space-between;padding:8px;margin:4px 0;background:white;border-radius:4px;font-size:14px}
.student-name{font-weight:600;color:var(--ink)}
.student-id{color:var(--muted);font-family:monospace}
.student-variant{background:var(--primary);color:white;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:600}
.info-box{background:#e0f2fe;color:#0c4a6e;padding:16px;border-radius:8px;margin:20px 0;border-left:4px solid #0284c7}
.success-box{background:#d1fae5;border:1px solid #6ee7b7;color:#065f46;padding:16px;border-radius:8px;margin:20px 0}
.warning-box{background:#fef3c7;border:1px solid #fbbf24;color:#92400e;padding:16px;border-radius:8px;margin:20px 0}
.footer{text-align:center;padding:40px 20px;color:var(--muted);font-size:14px}
.progress{margin:20px 0;padding:10px;background:#f9f9f9;border-radius:8px;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto}
.form-group{margin:15px 0}
.form-group label{display:block;margin-bottom:5px;font-weight:600;color:var(--ink);font-size:14px}
.form-control{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px}
.form-control:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
select.form-control{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.divider{border-top:2px solid var(--border);margin:30px 0}
.tabs{display:flex;gap:4px;margin-bottom:20px;background:#f3f4f6;padding:4px;border-radius:8px}
.tab{padding:10px 20px;border:none;background:transparent;color:var(--muted);font-weight:600;cursor:pointer;border-radius:6px;transition:all 0.2s}
.tab.active{background:white;color:var(--primary);box-shadow:0 2px 4px rgba(0,0,0,0.05)}
.tab-content{display:none}
.tab-content.active{display:block}
@media(max-width:600px){.course-selector{grid-template-columns:1fr}.tabs{flex-direction:column}}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìù Coursework LaTeX Generator</h1>
    <p>Generate Individual or Batch Assignments (NM & DS)</p>
  </div>

  <div class="card">
    <h2>üéØ Generation Mode</h2>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('individual', this)">Individual Generation</button>
      <button class="tab" onclick="switchTab('batch', this)">Batch Generation (All 19)</button>
    </div>

    <!-- Individual -->
    <div id="individual-tab" class="tab-content active">
      <div class="course-selector">
        <div class="course-btn active" data-course="cf" onclick="selectCourse('cf',this)">
          <h3>üìà Dynamical Systems</h3><p>Chaos & Fractals</p>
        </div>
        <div class="course-btn" data-course="nm" onclick="selectCourse('nm',this)">
          <h3>üî¢ Numerical Methods</h3><p>Algorithms & Analysis</p>
        </div>
      </div>

      <div class="form-group">
        <label for="studentSelect">Select Student from Class List:</label>
        <select id="studentSelect" class="form-control" onchange="updateSelectedStudent()">
          <option value="">-- Choose a student --</option>
        </select>
      </div>

      <div class="divider"></div>
      <div class="warning-box"><strong>OR</strong> enter custom student details below:</div>

      <div class="form-group">
        <label for="customName">Custom Student Name:</label>
        <input type="text" id="customName" class="form-control" placeholder="e.g., John Smith">
      </div>
      <div class="form-group">
        <label for="customID">Custom Student ID:</label>
        <input type="text" id="customID" class="form-control" placeholder="e.g., 21111234567" maxlength="11">
      </div>
      <div class="form-group">
        <label for="variantSelect">Variant Number (1‚Äì30):</label>
        <input type="number" id="variantSelect" class="form-control" min="1" max="30" value="1">
      </div>

      <div class="info-box">
        <strong>Auto-Variant:</strong> 1 + (last 6 digits of ID) mod 30<br>
        <strong>Override:</strong> set any variant 1‚Äì30
      </div>

      <div class="btn-group">
        <button class="btn-primary" onclick="generateIndividual()">üìÑ Generate Individual LaTeX</button>
        <button class="btn-success" onclick="downloadIndividual()">üíæ Download LaTeX File</button>
        <button class="btn-secondary" onclick="clearIndividualForm()">üîÑ Clear Form</button>
      </div>
    </div>

    <!-- Batch -->
    <div id="batch-tab" class="tab-content">
      <div class="course-selector">
        <div class="course-btn active" data-course="cf" onclick="selectCourse('cf',this)">
          <h3>üìà Dynamical Systems</h3><p>Chaos & Fractals</p>
        </div>
        <div class="course-btn" data-course="nm" onclick="selectCourse('nm',this)">
          <h3>üî¢ Numerical Methods</h3><p>Algorithms & Analysis</p>
        </div>
      </div>

      <div class="student-list" id="studentList"></div>

      <div class="info-box">
        <strong>Total Students:</strong> 19<br>
        <strong>Variants:</strong> Auto-calculated from Student IDs<br>
        <strong>Output:</strong> 19 LaTeX files
      </div>

      <div class="btn-group">
        <button class="btn-danger" onclick="generateAllStudents()">üöÄ Generate All 19 LaTeX Files</button>
        <button class="btn-success" onclick="downloadAllAsZip()">üì¶ Download All (individual files)</button>
      </div>
      <div id="progress" class="progress" style="display:none"></div>
    </div>
  </div>

  <div class="card">
    <h2>üìù LaTeX Output Preview</h2>
    <div class="success-box" style="display:none" id="compile-instructions">
      <strong>‚úÖ Files Generated!</strong>
      <ol style="margin:10px 0 0 20px">
        <li>Download the LaTeX file(s)</li>
        <li>Upload to Overleaf or compile with <code>pdflatex</code></li>
        <li>Each student has their personalized assignment</li>
      </ol>
    </div>
    <textarea id="latexOutput" class="preview-box" readonly>
% LaTeX output will appear here
% Use Individual or Batch generation to create files
    </textarea>
  </div>

  <div class="footer">
    <p>¬© 2025 Coursework Generator ‚Ä¢ NM & DS</p>
  </div>
</div>

<script>
// ==== Class list (same as yours) ====
const students = [
  {name: "Oli Bailey", id: "21111388943"},
  {name: "Tian Dawson-Shenton", id: "21111383107"},
  {name: "Billie Dawson", id: "21111373089"},
  {name: "Mia Greenhalgh", id: "21111387863"},
  {name: "Josh Hainsworth", id: "21111389833"},
  {name: "Alice Hughes", id: "21111388110"},
  {name: "Josh Hughes", id: "21111385475"},
  {name: "Holly Jones", id: "21111389807"},
  {name: "Jorge Lattimore", id: "21111388950"},
  {name: "Emily Morris", id: "21111382584"},
  {name: "James Oconnor", id: "21111389808"},
  {name: "Max Parrott", id: "21111388188"},
  {name: "Alfie Robinson", id: "21111385759"},
  {name: "Evie Schofield", id: "21111388083"},
  {name: "Harriet Shadbolt", id: "21111382216"},
  {name: "Kacper Swiatlowski", id: "21111388302"},
  {name: "Charlotte Tasker", id: "21111385728"},
  {name: "Louis Tornerup", id: "21111365511"},
  {name: "Amy Williams", id: "21111389832"}
];
students.forEach(s => { const last6 = parseInt(s.id.slice(-6),10); s.variant = 1 + (last6 % 30); });

// ==== UI state ====
let currentCourse = 'cf';
let generatedFiles = [];
let currentIndividualFile = null;

function switchTab(tab, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  el.classList.add('active'); document.getElementById(tab+'-tab').classList.add('active');
}
function populateStudentDropdown(){
  const sel = document.getElementById('studentSelect');
  sel.innerHTML = '<option value="">-- Choose a student --</option>';
  students.forEach((s,i)=>{
    const o=document.createElement('option');
    o.value=i; o.text = `${s.name} (${s.id}) - Variant ${s.variant}`; sel.appendChild(o);
  });
}
function updateSelectedStudent(){
  const idx = document.getElementById('studentSelect').value;
  if(idx!==''){ const s = students[idx];
    document.getElementById('customName').value='';
    document.getElementById('customID').value='';
    document.getElementById('variantSelect').value = s.variant;
  }
}
function clearIndividualForm(){
  document.getElementById('studentSelect').value='';
  document.getElementById('customName').value='';
  document.getElementById('customID').value='';
  document.getElementById('variantSelect').value='1';
  currentIndividualFile=null;
  document.getElementById('latexOutput').value = '% LaTeX output will appear here\n% Use Individual or Batch generation to create files';
  document.getElementById('compile-instructions').style.display='none';
}
function displayStudents(){
  const list = document.getElementById('studentList'); let html='';
  students.forEach(s=>{
    html += `<div class="student-item"><span class="student-name">${s.name}</span><span class="student-id">${s.id}</span><span class="student-variant">Variant ${s.variant}</span></div>`;
  });
  list.innerHTML = html;
}
function selectCourse(course, el){
  currentCourse = course;
  document.querySelectorAll('.course-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.course-btn[data-course="${course}"]`).forEach(b=>b.classList.add('active'));
}

// ==== RNG ====
function mulberry32(a){ return function(){ a|=0; a=(a+0x6D2B79F5)|0; var t=Math.imul(a^(a>>>15),1|a); t=(t+Math.imul(t^(t>>>7),61|t))^t; return ((t^(t>>>14))>>>0)/4294967296; } }
function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)]; }

// ==== Parameter pools ====
const pools = {
  nm: {
    q1Families: [
      {key:'ax_minus_bexp', params:{a:[1.5,2,2.5,3,3.5], b:[1.2,1.6,2,2.4,3], k:[0.8,1,1.2,1.6,2,2.5,3]}},
      {key:'cubic', params:{alpha:[0.7,1,2,3], beta:[1,2,3]}},
      {key:'coskx_minus_x', params:{k:[1,1.2,1.5,2]}},
      {key:'exp_minus_gamma_x', params:{gamma:[1.5,2,3,4]}},
      {key:'log_shift_minus_eta', params:{delta:[0.5,1,2], eta:[0.1,0.3,0.5]}}
    ],
    q2Funcs: [
      {f:"\\cos x",A:0,B:Math.PI},{f:"\\sin x",A:0,B:Math.PI},{f:"e^x",A:0,B:1.2},
      {f:"e^{0.6x}",A:0,B:2.2},{f:"\\ln(1+x)",A:0,B:0.9},{f:"\\sqrt{1+x^2}",A:0,B:1.6},
      {f:"\\arctan x",A:0,B:1.6},{f:"e^{x/2} \\\\cos x",A:0,B:1.8},{f:"(1+x)^{1/3}",A:0,B:0.8}
    ],
    q3Families: [
      {key:'ay', params:{a:[-1.2,-1,-0.8,0.6,0.8,1]}},
      {key:'x_plus_y', params:{}},
      {key:'mxy', params:{}},
      {key:'siny_y', params:{}},
      {key:'lin_forced', params:{lambda:[0.6,0.8,1,1.2], B:[1.2,1.6,2], omega:[0.9,1,1.2]}}
    ],
    q4Params: {c:[1.5,2,2.5,3], y0:[8,10,12,14], v0:[20,25,30,35,40]}
  },
  cf: {
    x0Choices: [[0.1,0.3,0.9],[0.12,0.34,0.78],[0.2,0.37,0.51],[0.05,0.25,0.85]],
    rVals:[2.8,3.2,3.45,3.55,3.62,3.7,3.83,3.9],
    abCases:[{a:1,b:1},{a:1.5,b:0.5},{a:3.25,b:1},{a:1.2,b:0.9},{a:1.6,b:0.5}],
    tentS:[1.6,1.7,1.8,1.9],
    juliaC:["-0.745+0.186i","-0.8+0.156i","-0.12-0.75i","-0.101+0.635i","0.2-0.2i","-0.75+0.1i","-0.1+0.62i"]
  }
};

// ==== NM generator (LaTeX) ====
function generateNMLaTeX(variant, student, sid){
  const rng = mulberry32(0xA11CE ^ variant);

  // Q1 eqn
  const fam1 = pick(rng, pools.nm.q1Families);
  const params1 = {};
  for(const k in fam1.params){ params1[k] = pick(rng, fam1.params[k]); }
  let eq1;
  if(fam1.key==='ax_minus_bexp'){ eq1 = `${params1.a} x - ${params1.b} e^{-${params1.k} x} = 0`;
  } else if(fam1.key==='cubic'){ eq1 = `x^3 - ${params1.alpha} x - ${params1.beta} = 0`;
  } else if(fam1.key==='coskx_minus_x'){ eq1 = `\\\\cos(${params1.k}x) - x = 0`;
  } else if(fam1.key==='exp_minus_gamma_x'){ eq1 = `e^x - ${params1.gamma} x = 0`;
  } else { eq1 = `\\\\ln(x+${params1.delta}) - ${params1.eta} = 0`; }

  // Q2 interval
  const Q2 = pick(rng, pools.nm.q2Funcs);
  const midpoint = ((Q2.A + Q2.B)/2).toFixed(4);

  // Q3 ODEs
  const fam3 = pick(rng, pools.nm.q3Families);
  let q3eq, q3exact;
  if(fam3.key==='ay'){
    const a = pick(rng, fam3.params.a);
    q3eq = `\\\\frac{dy}{dx} = ${a} y, \\\\quad y(0) = 1`;
    q3exact = `y = e^{${a}x}`;
  } else if(fam3.key==='x_plus_y'){
    q3eq = `\\\\frac{dy}{dx} = x + y, \\\\quad y(0) = 1`;
    q3exact = `y = 2 e^{x} - x - 1`;
  } else if(fam3.key==='mxy'){
    q3eq = `\\\\frac{dy}{dx} = -2xy, \\\\quad y(0) = 2`;
    q3exact = `y = 2 e^{-x^2}`;
  } else if(fam3.key==='siny_y'){
    q3eq = `\\\\frac{dy}{dx} = (\\\\sin x) y, \\\\quad y(0) = 1`;
    q3exact = `y = e^{1 - \\\\cos x}`;
  } else {
    const lambda = pick(rng, fam3.params.lambda);
    const B = pick(rng, fam3.params.B);
    const omega = pick(rng, fam3.params.omega);
    q3eq = `\\\\frac{dy}{dx} = -${lambda} y + ${B} \\\\cos(${omega} x), \\\\quad y(0) = 1`;
    const denom = lambda*lambda + omega*omega;
    const AcoefVal = (B/denom).toFixed(4);
    const CcoefVal = (1 - (B*lambda)/denom).toFixed(4);
    q3exact = `y = ${AcoefVal}\\\\, ( ${lambda.toFixed(3)} \\\\cos(${omega.toFixed(3)}x) + ${omega.toFixed(3)} \\\\sin(${omega.toFixed(3)}x) ) + ${CcoefVal}\\\\, e^{-${lambda.toFixed(3)}x}`;
  }

  // Q4 specific solution coefficients (tidy signs)
  const P4 = { c: pick(rng, pools.nm.q4Params.c), y0: pick(rng, pools.nm.q4Params.y0), v0: pick(rng, pools.nm.q4Params.v0) };
  const Acoef = ((3*P4.y0 + (2*P4.v0)/P4.c)/2);
  const Bcoef = (P4.y0 - Acoef);
  const AcoefStr = Acoef.toFixed(4), BcoefStr = Bcoef.toFixed(4);

  // Document
  let latex = '';
  latex += '\\\\documentclass[11pt,a4paper]{article}\\n';
  latex += '\\\\usepackage[margin=2.5cm]{geometry}\\n';
  latex += '\\\\usepackage{amsmath,amssymb,amsthm,mathtools}\\n';
  latex += '\\\\usepackage{graphicx}\\n';
  latex += '\\\\usepackage{enumitem}\\n';
  latex += '\\\\usepackage{fancyhdr}\\n\\n';
  latex += '\\\\pagestyle{fancy}\\\\fancyhf{}\\\\lhead{\\\\textbf{NUMERICAL METHODS}}';
  latex += `\\\\rhead{\\\\textbf{VARIANT ${variant}}}\\\\cfoot{\\\\thepage}\\n\\\\thispagestyle{empty}\\n\\n`;
  latex += '\\\\begin{document}\\n\\n\\\\begin{center}\\n';
  latex += '{\\\\LARGE \\\\textbf{NUMERICAL METHODS}}\\\\\\\\[0.5em]\\n';
  latex += `{\\\\Large \\\\textbf{VARIANT ${variant}}}\\\\\\\\[1em]\\n`;
  latex += `{\\\\large Student: ${student}}\\\\\\\\\\n{\\\\large ID: ${sid}}\\\\\\\\[0.5em]\\n\\\\rule{\\\\textwidth}{0.4pt}\\n\\\\end{center}\\n\\n';
  latex += '\\\\vspace{1em}\\n\\\\noindent\\\\textbf{Marking:} Q1 (15) + Q2 (15) + Q3 (15) + Q4 (15) + Q5 (40) = 100 marks\\n\\n';

  // Q1
  latex += '\\\\section*{Question 1: Root-finding algorithms ‚Äî 15 marks}\\n\\n';
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]\\n';
  latex += '\\\\item For the equation\\\\[ '+eq1+' \\\\] find three different rearrangements $x=g(x)$ for the fixed-point scheme $x_{n+1}=g(x_n)$ such that:';
  latex += '\\\\begin{enumerate}[label=\\\\roman*.]\\\\item Converges to a real root.\\\\item Converges to the same real root but faster.\\\\item Fails to converge.\\\\end{enumerate}';
  latex += ' Compute 30 iterations from $x_0=0.4$ and explain each behaviour.\\\\hfill [5 marks]\\n\\n';
  latex += '\\\\item Newton‚ÄìRaphson on the same equation:';
  latex += '\\\\begin{enumerate}[label=\\\\roman*.]';
  latex += '\\\\item Show 10 iterations from any start and give the solution to 10 d.p.;';
  latex += '\\\\item Estimate the order of convergence and the asymptotic error constant $A$;';
  latex += '\\\\item Check agreement with $A = \\\\dfrac{f\'\'(x^*)}{2 f\'(x^*)}$.';
  latex += '\\\\end{enumerate}\\\\hfill [7 marks]\\n\\n';
  latex += '\\\\item Brief note on Newton‚Äôs method for multiple roots (e.g. $(x-1)^3=0$).\\\\hfill [3 marks]\\n\\\\end{enumerate}\\n\\n';

  // Q2
  latex += '\\\\section*{Question 2: Taylor expansions ‚Äî 15 marks}\\n\\n';
  latex += `Take $y(x)=${Q2.f}$ on $[${Q2.A.toFixed(4)}, ${Q2.B.toFixed(4)}]$. The arc length is $l=\\\\int_a^b \\\\sqrt{1+(y')^2}\\\\,dx$.`;
  latex += ` Expand the integrand about $x=${midpoint}$ and approximate $l$.\\\\n\\\\n`;
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item Order-6 Taylor approximation at the midpoint; plot Taylor vs $I(x)=\\\\sqrt{1+(dy/dx)^2}$.\\\\hfill [3]';
  latex += '\\\\item Provide a justified upper bound for the error in (a).\\\\hfill [7]';
  latex += '\\\\item Add degree 7‚Äì10 approximations; tabulate and state best decimal-place accuracy.\\\\hfill [3]';
  latex += '\\\\item Use symmetry/periodicity (if applicable) to extend to a larger interval and verify numerically.\\\\hfill [2]';
  latex += '\\\\end{enumerate}\\n\\n';

  // Q3
  latex += '\\\\section*{Question 3: First-order ODEs ‚Äî 15 marks}\\n\\n';
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item Describe basic vs modified Euler, with sketches; explain why the modified method is more accurate.\\\\hfill [5]';
  latex += `\\\\item Basic Euler with $h=0.05$ to estimate $y$ at $x=0.1$ for \\\\[ ${q3eq} \\\\] \\\\hfill [3]`;
  latex += '\\\\item For the same IVP, perform 10 steps of size 0.5 (modified Euler and RK4) from $y(0)$ to $y(5)$.\\\\hfill [3]';
  latex += `\\\\item The true solution is \\\\[ ${q3exact} \\\\] Plot truth vs approximations and comment.\\\\hfill [4]`;
  latex += '\\\\end{enumerate}\\n\\n';

  // Q4 (signs/spaces tidied)
  latex += '\\\\section*{Question 4: Second-order ODEs ‚Äî 15 marks}\\n\\n';
  latex += 'Two touching blocks on a steel top at $0^\\\\circ$C lead to\\\\[ \\\\frac{d^2 y}{dx^2} = -2c \\\\frac{dy}{dx} - 0.75 c^2 y. \\\\]';
  latex += `Take $c=${P4.c}$, $y(0)=${P4.y0}$, $y'(0)=${P4.v0}$.\\\\n\\\\n`;
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item State a modified-Euler scheme for second-order ODEs (define introduced variables).\\\\hfill [4]';
  latex += '\\\\item Use the scheme with $h=0.1$ for 10 steps and report $y(1)$ only.\\\\hfill [3]';
  latex += '\\\\item From (b), bracket a local maximum and justify the interval.\\\\hfill [2]';
  latex += `\\\\item The specific solution is \\\\[ y = ${AcoefStr} \\\\; e^{-${(P4.c/2).toFixed(3)} x} - ${Math.abs(Bcoef).toFixed(4)} \\\\; e^{-${(3*P4.c/2).toFixed(3)} x} \\\\] (sign shown explicitly). Verify, then use $y'(x)$ with a few secant iterations starting from your bracket to locate the maximum.\\\\hfill [6]`;
  latex += '\\\\end{enumerate}\\n\\n';

  // Q5
  latex += '\\\\section*{Question 5: Presentation ‚Äî 40 marks}\\n\\n';
  latex += '\\\\textbf{Draft (10):} 150‚Äì250 words + 1-slide storyboard, due 48h before your slot. \\\\emph{Draft marks awarded only if you present.}\\\\n\\\\n';
  latex += '\\\\textbf{Presentation (30):} 3 minutes.\\\\begin{itemize}\\\\item Show variant number\\\\item Present one quantitative result from Q1‚ÄìQ4\\\\item Explain method and rationale\\\\item Brief reflection\\\\end{itemize}';
  latex += '\\\\textbf{Rubric: }Draft ‚Äî Structure \\\\& focus (3), Mathematical soundness (3), Evidence plan (2), References/tools (2). ';
  latex += 'Presentation ‚Äî Correctness \\\\& insight (12), Method rationale (8), Clarity \\\\& structure (5), Visuals (3), Timing \\\\& delivery (2).\\\\n\\\\n';

  latex += '\\\\end{document}';
  return latex;
}

// ==== DS generator (LaTeX) ====
function generateCFLaTeX(variant, student, sid){
  const rng = mulberry32(0xBEE5 ^ variant);

  // Q1: parameterized logistic map (to align with (a,b) references)
  const xs = pick(rng, pools.cf.x0Choices);
  const ab = pick(rng, pools.cf.abCases);
  const xsStr = xs.join(', ');

  // Q2: Tent map (explicitly different from Q1)
  const sTent = pick(rng, pools.cf.tentS);
  const c1 = pick(rng, pools.cf.juliaC);
  const c2 = pick(rng, pools.cf.juliaC.filter(c=>c!==c1));

  let latex = '';
  latex += '\\\\documentclass[11pt,a4paper]{article}\\n';
  latex += '\\\\usepackage[margin=2.5cm]{geometry}\\n';
  latex += '\\\\usepackage{amsmath,amssymb,amsthm,mathtools}\\n';
  latex += '\\\\usepackage{graphicx}\\n';
  latex += '\\\\usepackage{enumitem}\\n';
  latex += '\\\\usepackage{fancyhdr}\\n\\n';
  latex += '\\\\pagestyle{fancy}\\\\fancyhf{}\\\\lhead{\\\\textbf{DYNAMICAL SYSTEMS, CHAOS \\\\& FRACTALS}}';
  latex += `\\\\rhead{\\\\textbf{VARIANT ${variant}}}\\\\cfoot{\\\\thepage}\\n\\\\thispagestyle{empty}\\n\\n`;
  latex += '\\\\begin{document}\\n\\n\\\\begin{center}\\n';
  latex += '{\\\\LARGE \\\\textbf{DYNAMICAL SYSTEMS, CHAOS \\\\& FRACTALS}}\\\\\\\\[0.5em]\\n';
  latex += `{\\\\Large \\\\textbf{VARIANT ${variant}}}\\\\\\\\[1em]\\n`;
  latex += `{\\\\large Student: ${student}}\\\\\\\\\\n{\\\\large ID: ${sid}}\\\\\\\\[0.5em]\\n\\\\rule{\\\\textwidth}{0.4pt}\\n\\\\end{center}\\n\\n';
  latex += '\\\\vspace{1em}\\n\\\\noindent\\\\textbf{Marking:} Q1 (15) + Q2 (15) + Q3 (15) + Q4 (15) + Q5 (40) = 100 marks\\n\\n';

  // Q1 ‚Äî parameterized logistic map
  latex += '\\\\section*{Question 1: One-dimensional maps ‚Äî 15 marks}\\n\\n';
  latex += 'For a one-dimensional real function $f:\\\\mathbb{R}\\\\to\\\\mathbb{R}$, define $x_{n+1}=f(x_n)$, $n=0,1,2,\\\\ldots$\\\\n\\\\n';
  latex += 'One such map is\\\\[ x_{n+1} = a\\\\, x_n \\\\bigl(1 - b\\\\, x_n\\\\bigr), \\\\qquad x_0 \\\\in (0,1) \\\\]';
  latex += `with $x_0 \\\\in \\\\{${xsStr}\\\\}$.\\\\n\\\\n`;
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item For $a=b=0.5$, show the population eventually reaches zero for all $x_0\\\\in(0,1)$. Compute $x_n$ for $n=0..20$ using $x_0=0.1,0.3,0.9$ and plot them on one labelled figure. \\\\hfill [5]';
  latex += '\\\\item For $a=b=0.5$ and $x_0=0.3$, compute the number of iterations until $x_n < 10^{-15}$. \\\\hfill [4]';
  latex += '\\\\item Describe behaviour (with suitable plots) for: (i) $a=1,b=1$, (ii) $a=1.5,b=0.5$, (iii) $a=3.25,b=1$, using $x_0=0.1$. \\\\hfill [6]';
  latex += '\\\\end{enumerate}\\n\\n';

  // Q2 ‚Äî Tent map (explicit domain)
  latex += '\\\\section*{Question 2: Fixed and periodic points (Tent map) ‚Äî 15 marks}\\n\\n';
  latex += `Use the tent map\\\\[ f(x)= ${sTent}\\\\cdot\\\\min(x,1-x), \\\\qquad x\\\\in[0,1] \\\\] and keep it fixed for (a)‚Äì(e).\\\\n\\\\n`;
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item Plot $y=f(x)$ and $y=x$ on $[0,1]$ (one set of axes). \\\\hfill [2]';
  latex += '\\\\item Find all fixed points algebraically and relate them to your plot. \\\\hfill [3]';
  latex += '\\\\item Classify fixed points by $\\\\lvert f\'(x^*)\\\\rvert$ (attracting/repelling). \\\\hfill [3]';
  latex += '\\\\item Find periodic points up to period 3 and their stability. \\\\hfill [5]';
  latex += '\\\\item Using (c)‚Äì(d), discuss likely long-term behaviour for typical initial conditions (no orbit plots required). \\\\hfill [2]';
  latex += '\\\\end{enumerate}\\n\\n';

  // Q3 ‚Äî Julia sets (unchanged content, tidied LaTeX)
  latex += '\\\\section*{Question 3: Filled Julia sets ‚Äî 15 marks}\\n\\n';
  latex += 'Given $g:\\\\mathbb{C}\\\\to\\\\mathbb{C}$ with $z_{n+1}=g(z_n)$, take $g(z)=z^2+c$. If $\\\\lvert z_n\\\\rvert>2$ for some $n$, the orbit escapes; the first such $n$ is the escape iteration.\\\\n\\\\n';
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item Write a function to return the escape iteration for $(z_0,c)$ with maximum $n_{\\\\text{Max}}$ (return $n_{\\\\text{Max}}$ if never $>2$). \\\\hfill [3]';
  latex += `\\\\item Plot the filled Julia set for $c=${c1}$ on a $500\\\\times 500$ grid with $\\\\operatorname{Re},\\\\operatorname{Im}\\\\in[-1,1]$, $n_{\\\\text{Max}}=100$; colour by escape iteration and include a colour bar. \\\\hfill [7]`;
  latex += `\\\\item Repeat for $c=${c2}$ with $n_{\\\\text{Max}}=50,100,1000$ (as feasible) and comment on connectivity/filaments. \\\\hfill [5]`;
  latex += '\\\\end{enumerate}\\n\\n';

  // Q4 ‚Äî crumpled paper (unchanged content, tidy)
  latex += '\\\\section*{Question 4: Fractal dimension of a crumpled piece of paper ‚Äî 15 marks}\\n\\n';
  latex += 'Context (read-only). Estimate the fractal dimension via $M \\\\propto R^D$ (take sheet area as mass proxy).\\\\n';
  latex += 'Follow the cohort data protocol (Steps 1‚Äì5; use the shared Data Analysis Lab sheet).\\\\n\\\\n';
  latex += '\\\\begin{enumerate}[label=(\\\\alph*)]';
  latex += '\\\\item Method \\\\& log‚Äìlog: build a dataset of $\\\\ge 5$ points ($\\\\ge 3$ yours + $\\\\ge 2$ cohort), convert to $R$ (cm), $M$ (cm$^2$); plot $y=\\\\log M$ vs $x=\\\\log R$; note outliers/decisions. \\\\hfill [5]';
  latex += '\\\\item Estimating $D$ \\\\& robustness: least-squares $y=\\\\alpha + D x$; report $\\\\hat D$, $R^2$, and 95\\\\% CI or SE; repeat on a different subset and compare; state if $\\\\hat D\\\\in(2,3)$ and implication. \\\\hfill [6]';
  latex += '\\\\item Interpretation (150‚Äì200 words): uncertainties, paper/size effects, and why pooling clarifies scaling. \\\\hfill [4]';
  latex += '\\\\end{enumerate}\\n\\n';

  // Q5 ‚Äî presentation
  latex += '\\\\section*{Question 5: Presentation ‚Äî 40 marks}\\n\\n';
  latex += '\\\\textbf{Draft (10):} 150‚Äì250 words + 1-slide storyboard, due 48h before your slot (awarded only if you present).\\\\n\\\\n';
  latex += '\\\\textbf{Presentation (30):} 3 minutes. Show variant; present one quantitative result from Q1‚ÄìQ4; method rationale; reflection.\\\\n';
  latex += '\\\\textbf{Rubric: }Draft ‚Äî Structure \\\\& focus (3), Mathematical soundness (3), Evidence plan (2), References/tools (2). ';
  latex += 'Presentation ‚Äî Correctness \\\\& insight (12), Method rationale (8), Clarity \\\\& structure (5), Visuals (3), Timing \\\\& delivery (2).\\\\n\\\\n';

  latex += '\\\\end{document}';
  return latex;
}

// ==== Generate individual / batch ====
function generateIndividual(){
  const sel = document.getElementById('studentSelect');
  const customName = document.getElementById('customName').value.trim();
  const customID = document.getElementById('customID').value.trim();
  const variant = parseInt(document.getElementById('variantSelect').value);
  let studentName, studentID;

  if(sel.value!==''){ const s=students[sel.value]; studentName=s.name; studentID=s.id; }
  else if(customName && customID){ studentName=customName; studentID=customID; }
  else { alert('Please select a student OR enter custom name and ID'); return; }

  if(isNaN(variant)||variant<1||variant>30){ alert('Variant must be between 1 and 30'); return; }

  const latex = currentCourse==='nm'
    ? generateNMLaTeX(variant, studentName, studentID)
    : generateCFLaTeX(variant, studentName, studentID);

  currentIndividualFile = { name: (currentCourse==='nm'?'NM_':'CF_')+studentID+'.tex', content: latex, student: studentName, variant };
  document.getElementById('latexOutput').value = latex;
  document.getElementById('compile-instructions').style.display = 'block';
  alert('Generated: '+studentName+' (Variant '+variant+')');
}

function downloadIndividual(){
  if(!currentIndividualFile){ alert('Generate a file first!'); return; }
  const blob = new Blob([currentIndividualFile.content], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=currentIndividualFile.name; a.click(); URL.revokeObjectURL(url);
}

function generateAllStudents(){
  const progress = document.getElementById('progress');
  progress.style.display='block'; progress.innerHTML='<strong>Generating LaTeX files...</strong><br>';
  generatedFiles = [];
  students.forEach(s=>{
    const latex = currentCourse==='nm'
      ? generateNMLaTeX(s.variant, s.name, s.id)
      : generateCFLaTeX(s.variant, s.name, s.id);
    generatedFiles.push({name:(currentCourse==='nm'?'NM_':'CF_')+s.id+'.tex', content:latex, student:s.name, variant:s.variant});
    progress.innerHTML += `‚úì ${s.name} (Variant ${s.variant})<br>`;
  });
  progress.innerHTML += '<br><strong>‚úÖ All 19 files generated successfully!</strong>';
  document.getElementById('compile-instructions').style.display='block';
  if(generatedFiles.length>0){ document.getElementById('latexOutput').value = generatedFiles[0].content; }
}

function downloadAllAsZip(){
  if(generatedFiles.length===0){ alert('Generate files first!'); return; }
  generatedFiles.forEach((file,i)=>{
    setTimeout(()=>{
      const blob=new Blob([file.content],{type:'text/plain'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url);
    }, i*200);
  });
  alert('Downloading '+generatedFiles.length+' files...\nFor a .zip, include a ZIP library like JSZip.');
}

// Init
function populate(){ populateStudentDropdown(); displayStudents(); }
populate();
</script>

</body>
</html>
